<!DOCTYPE html>
<html>

<head>

    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Lato&family=Lobster&family=Patrick+Hand&family=Roboto&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital@1&family=Roboto&family=Ruda:wght@600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <link href="styles/styles.css" rel="stylesheet">


</head>

<body>
    <div class="wrapper" hidden>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menuContent"
                aria-controls="menuContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse " id="menuContent">
                <ul class="navbar-nav mr-auto navigation ">
                    <li class="nav-item active p-2">
                        <a class="nav-link" href="home.html"><i class="fas fa-home nav-icon mx-2"></i>Начало</a>
                    </li>
                    <li class="nav-item p-2">
                        <a class="nav-link" href="newCarOffer.html"><i class="fas fa-plus mx-2"></i>Нова Оферта</a>
                    </li>
                    <li class="nav-item p-2 ">
                        <a class="nav-link" href="myCarOffers.html"><i class="fas fa-car mx-2"></i></i>Моите оферти</a>
                    </li>
                    <li class="nav-item p-2 ">
                        <a class="nav-link" href="profile.html"><i class="fas fa-user-cog nav-icon mx-2"></i>Профил</a>
                    </li>
                    <li class="nav-item p-2">
                        <a class="nav-link" href="#" id="logout"><i
                                class="fas fa-sign-out-alt nav-icon mx-2"></i>Изход</a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- End of navigation-->
        <!-- Content -->
        <div class="container-lg mt-lg-4 rounded containerTop">
            <div class="p-2">
                <!--Butttons -->
                <div class="d-flex flex-row justify-content-end m-3">
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View All Cars"
                            id="getAll">Всички</button>
                    </div>
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View cars in list" id="listView"><i
                                class="fas fa-bars"></i></button>
                    </div>
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View cars in grid" id="gridView"><i
                                class="fa fa-th-large" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
            <!--Търсачки -->
            <div class="d-flex align-items-start row">
                <div class="col-md-12 col-lg-4 ">
                    <div class="form-group">
                        <label for="search">Търси по описание:</label>
                        <form class="form">
                            <input class="form-control" type="search" id="search-description" placeholder="Описание" aria-label="Търси">
                        </form>
                    </div>
                </div>
                <div class="col-md-12 col-lg-4 align-items-center flex-row">
                    <div class="form-group">
                        <label for="car-brand-filter">Търси по марка</label>
                        <select class="form-control" id="car-brand-filter" name="brand">
                        </select>
                    </div>
                </div>
                <div class="col-md-12 col-lg-4 align-items-center flex-row" hidden id="modelSelect">
                    <div class="form-group" id="modelFormGroup">
                        <label for="car-model-filter">Търси по марка и модел</label>
                        <select class="form-control" id="car-model-filter" name="model">
                        </select>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- container for all the cards -->
        <div class="cars-container container-lg mt-lg-2 rounded">
            <ul class="list-group-cars justify-content-center pl-0 " id="car-list">
            </ul>
        </div>

    </div>

    <li class="mt-sm-1 m-sm-1 mt-lg-3 mr-0 ml-0 list-group-item rounded " style="display: none;" id="cloneCar">
        <div class="row  p-sm-2 p-lg-2 item-container mt-2">
            <div class="col-sm-4 col-lg-4 car-image-container d-flex justify-content-center w-75">
                <img src="assets/empty-image.jpg" class="img-fluid img-responsive thumbnail  carImage ">
            </div>

            <div class="col-sm-8 col-lg-8 car-info-container mt-3">
                <div class=" info d-flex flex-row ">
                    <!--flex-row -->
                    <div class="brandinfo col-8 d-flex-column">
                        <div class="d-flex flex-sm-column  flex-lg-row ">
                            <h5 class="carBrand text-left headInfo">Марка</h5>
                            <h5 class="carModel text-left pl-lg-2 headInfo">Модел</h5>
                        </div>
                        <div class="d-inline-flex">
                            <h5 class="text-left">Двигател:</h5>
                            <h5 class="carEngine pl-2">Двигател</h5>
                        </div>
                    </div>
                    <div class="priceinfo col-4">
                        <div class="price-cantainer d-flex flex-row justify-content-end ">
                            <!--justify-content-end-->
                            <h5 class="">Цена: </h5>
                            <h5 class="carPrice pl-2">Цена</h5>
                            <h5 class="pl-2">лв.</h5>
                        </div>
                    </div>
                </div>
                <div class="mt-2  text-wrap">
                    <h6 class="description">Описание:</h6>
                    <h5 class="shortDescription">Описание</h5>
                </div>
            </div>
        </div>
    </li>

    <script>
        $(document).ready(function () {
            /*Взима логнат потребител, за да покаже страницата*/
            var loggedUser;
            var getLoggedUser = async function () {
                return $.ajax({
                    url: "/loggedUser",
                    method: "GET",
                    complete: function (data) {
                        switch (data.status) {
                            case 200:
                                loggedUser = data.responseJSON;
                                break;
                            case 401:
                                window.location.href = "index.html";
                                break;
                        }
                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadPageContent = async function () {
                loggedUser = await getLoggedUser();
                if (loggedUser != 'undefined') {
                    $('.wrapper').removeAttr('hidden');
                }
            }
            $('#logout').on('click', function () {
                $.ajax({
                    url: "logout",
                    method: "POST",
                    complete: function (data) {
                        if (data.status == 401) {
                            alert("ERROR!");
                        }
                        window.location.href = "index.html";
                    }
                })
            });
            /*До тук за потребителя*/


            /*Връща всички оферти за коли*/
            var getAllCarsData = async function () {
                return $.ajax({
                    url: "/carOffers/all",
                    method: "GET",
                    success: function (response) {
                        return response;
                    }
                });
            }
            var buildCarsView = function (data) {
                $('#car-list').empty();
                data.forEach(element => {
                    bindCarsData(element);
                });
            }
            var bindCarsData = function (element) {

                let miniCar = $('#cloneCar').clone();

                miniCar.attr("id", element.id);
                miniCar.find('.carImage').attr("src", element.carImage);
                miniCar.find('.carBrand').text(element.carBrand.brand);
                miniCar.find('.carModel').text(element.carModel.model);
                miniCar.find('.carEngine').text(element.engine);
                miniCar.find('.carPrice').text(element.price);
                miniCar.find('.shortDescription').text(element.shortDescription);

                $('#car-list').prepend(miniCar);
                miniCar.show();
            }
            
            var loadCarsData = async function () {
                let data = await getAllCarsData();
                buildCarsView(data);
                loadBrandsData()
                $('#containerTop').removeAttr('hidden');
            }
            /*Връща всички оферти за коли*/


            /*Display Brands*/
            var getBrands = async function () {
                return $.ajax({
                    url: "/carBrands/all",
                    method: "GET",
                    complete: function (data) {
                        return data.responseJSON;

                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadBrandsSelection = function (dropdown, element) {
                dropdown.append($('<option></option>').attr('value', element.id).text(element.brand));
            }
            var loadBrandsData = async function () {
                let carBrands = await getBrands();
                let dropdown = $('#car-brand-filter');
                dropdown.empty();
                dropdown.append('<option selected="true" disabled>Изберете марка автомобил</option>');
                dropdown.prop('selectedIndex', 0);
                carBrands.forEach(element => {
                    loadBrandsSelection(dropdown, element);
                });
            }
            /*Display Brands*/



            /*Display Models*/
            var getModels = async function () {
                return $.ajax({
                    url: "/carModels/brand",
                    method: "GET",
                    data: {
                        carBrand: $('#car-brand-filter :selected').val()
                    },
                    complete: function (data) {
                        return data.responseJSON;

                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadModelsSelection = function (dropdown, element) {
                dropdown.append($('<option></option>').attr('value', element.id).text(element.model));
            }
            var loadModelsData = async function () {
                let carModels = await getModels();

                let selectModel = $('#car-model-filter');
                selectModel.empty();
                selectModel.append('<option selected="true" disabled>Изберете модел автомобил</option>');
                selectModel.prop('selectedIndex', 0);
                carModels.forEach(element => {
                    loadModelsSelection(selectModel, element);
                });
                $('#modelSelect').removeAttr('hidden');
            }
            /*Събития при натискане на бутон*/
            $('#getAll').on('click', function () {
                $('#search-description').val("")
                $('#car-brand-filter')[0].selectedIndex = 0;
                $('#car-model-filter')[0].selectedIndex = 0;
                $('#modelSelect').attr('hidden', true);
                loadCarsData();
            });
            $('#listView').on('click', function () {
                $('.cars-container').removeClass("container-fluid");
                $('.cars-container').addClass("container-lg");
                $('#car-list').removeClass("d-flex row flex-wrap");
                $('.list-group-item').removeClass("col-3");
                $('.item-container').addClass("row");
                $('.car-image-container').addClass("col-sm-4 col-lg-4");
                $('.car-info-container').addClass("col-sm-8 col-lg-8");
                $('.info').addClass("flex-row");
                $('.info').removeClass("flex-column");
                $('.price-cantainer').addClass("justify-content-end");
                $('.brandinfo').addClass("col-8");
                $('.priceinfo').addClass("col-4");
            });
            $('#gridView').on('click', function () {
                $('.cars-container').removeClass("container-lg");
                $('.cars-container').addClass("container-fluid");
                $('#car-list').addClass("d-flex row flex-wrap");
                $('.list-group-item').addClass("col-3");
                $('.item-container').removeClass("row");
                $('.car-image-container').removeClass("col-sm-4 col-lg-4");
                $('.car-info-container').removeClass("col-sm-8 col-lg-8");
                $('.info').removeClass("flex-row");
                $('.info').addClass("flex-column");
                $('.price-cantainer').removeClass("justify-content-end");
                $('.brandinfo').removeClass("col-8");
                $('.priceinfo').removeClass("col-4");
            });

            /*Събития при промяна на селекта*/
            $('#car-brand-filter').on('change', async function () {
                loadModelsData();
                $('#search-description').val("")
                let selectedFilter = $('#car-brand-filter :selected').val();
                let data = await getAllCarsData();
                let filteredData = data.filter(element => {
                    return element.carBrand.id == selectedFilter;
                });
                buildCarsView(filteredData);
            });

            $('#car-model-filter').on('change', async function () {
                $('#search-description').val("")
                let selectedFilterBrand = $('#car-brand-filter :selected').val();
                let selectedFilterModel = $('#car-model-filter :selected').val();
                let data = await getAllCarsData();
                let filteredData = data.filter(element => {
                    return (element.carBrand.id == selectedFilterBrand && element.carModel.id == selectedFilterModel);
                });
                buildCarsView(filteredData);
            });

            /*Търсачка по описание*/
            $('#search-description').on('keyup', async function () {

                $('#car-brand-filter')[0].selectedIndex = 0;
                $('#car-model-filter')[0].selectedIndex = 0;
                $('#modelSelect').attr('hidden', true);

                let value = $(this).val().toLowerCase();

                var getFilteredData = async function () {

                    let data = await getAllCarsData();

                    console.log(data);
                    let filteredData = data.filter(element => {
                        return element.shortDescription.toLowerCase().includes(value);
                    });

                    buildCarsView(filteredData);
                }
                setTimeout(getFilteredData, 500);
            });

            loadPageContent();
            loadCarsData();

        });

    </script>

</body>

</html>