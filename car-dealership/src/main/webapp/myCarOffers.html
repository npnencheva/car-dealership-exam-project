<!DOCTYPE html>
<html>

<head>

    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Lato&family=Lobster&family=Patrick+Hand&family=Roboto&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital@1&family=Roboto&family=Ruda:wght@600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="jquery-validation/dist/jquery.validate.min.js"></script>


    <link href="styles/styles.css" rel="stylesheet">


</head>

<body>
    <div class="wrapper" hidden>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menuContent"
                aria-controls="menuContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse " id="menuContent">
                <ul class="navbar-nav mr-auto navigation ">
                    <li class="nav-item p-2">
                        <a class="nav-link" href="home.html"><i class="fas fa-home nav-icon mx-2"></i>Начало</a>
                    </li>
                    <li class="nav-item p-2">
                        <a class="nav-link" href="newCarOffer.html"><i class="fas fa-plus mx-2"></i>Нова Оферта</a>
                    </li>
                    <li class="nav-item p-2 active">
                        <a class="nav-link" href="myCarOffers.html"><i class="fas fa-car mx-2"></i></i>Моите оферти</a>
                    </li>
                    <li class="nav-item p-2 ">
                        <a class="nav-link" href="profile.html"><i class="fas fa-user-cog nav-icon mx-2"></i>Профил</a>
                    </li>
                    <li class="nav-item p-2">
                        <a class="nav-link" href="#" id="logout"><i
                                class="fas fa-sign-out-alt nav-icon mx-2"></i>Изход</a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- End of navigation-->
        <!-- Content -->
        <div class="container-lg mt-lg-4 rounded containerTop">
            <div class="p-2">
                <!--Butttons -->
                <div class="d-flex flex-row justify-content-end m-3">
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View All Cars"
                            id="getAll">Всички</button>
                    </div>
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View cars in list" id="listView"><i
                                class="fas fa-bars"></i></button>
                    </div>
                    <div class="ml-sm-1 ml-md-3">
                        <button type="button" class="btn btn-outline-primary" alt="View cars in grid" id="gridView"><i
                                class="fa fa-th-large" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
            <!--Търсачки -->
            <div class="d-flex align-items-start row">
                <div class="col-md-12 col-lg-4 ">
                    <div class="form-group">
                        <label for="search">Търси по описание:</label>
                        <form class="form">
                            <input class="form-control" type="search" id="search-description" placeholder="Описание"
                                aria-label="Търси">
                        </form>
                    </div>
                </div>
                <div class="col-md-12 col-lg-4 align-items-center flex-row">
                    <div class="form-group">
                        <label for="car-brand-filter">Търси по марка</label>
                        <select class="form-control" id="car-brand-filter" name="brand">
                        </select>
                    </div>
                </div>
                <div class="col-md-12 col-lg-4 align-items-center flex-row" hidden id="modelSelect">
                    <div class="form-group" id="modelFormGroup">
                        <label for="car-model-filter">Търси по марка и модел</label>
                        <select class="form-control" id="car-model-filter" name="model">
                        </select>
                    </div>
                </div>

            </div>
        </div>

        <!-- container for all the cards -->
        <div class="cars-container container-lg mt-lg-2 rounded">
            <ul class="list-group-cars justify-content-center pl-0 " id="car-list">
            </ul>
        </div>

    </div>

    <li class="mt-sm-1 m-sm-1 mt-lg-3 mr-0 ml-0 list-group-item rounded " style="display: none;" id="cloneCar">
        <div class="d-flex flex-column">
            <div class="row  p-sm-2 p-lg-2 item-container mt-2">
                <div class="col-sm-4 col-lg-4 car-image-container d-flex justify-content-center w-75">
                    <img src="assets/empty-image.jpg" class="img-fluid img-responsive thumbnail  carImage ">
                </div>
                <div class="col-sm-8 col-lg-8 car-info-container mt-3">
                    <div class=" info d-flex flex-row ">
                        <!--flex-row -->
                        <div class="brandinfo col-8 d-flex-column">
                            <div class="d-flex flex-sm-column  flex-lg-row ">
                                <h5 class="carBrand text-left headInfo">Марка</h5>
                                <h5 class="carModel text-left pl-lg-2 headInfo">Модел</h5>
                            </div>
                            <div class="d-inline-flex">
                                <h5 class="text-left">Двигател:</h5>
                                <h5 class="carEngine pl-2">Двигател</h5>
                            </div>
                        </div>
                        <div class="priceinfo col-4">
                            <div class="price-cantainer d-flex flex-row justify-content-end ">
                                <!--justify-content-end-->
                                <h5 class="">Цена: </h5>
                                <h5 class="carPrice pl-2">Цена</h5>
                                <h5 class="pl-2">лв.</h5>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2  text-wrap">
                        <h6 class="description">Описание:</h6>
                        <h5 class="shortDescription">Описание</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex flex-row justify-content-end ">
            <button type="button" class="m-1 btn btn-primary update" data-toggle="modal" data-target="#editCarOfferModal">
                <i class="fas fa-redo-alt mr-2"></i>Редактирай
            </button>
            <button type="button" class="m-1 btn btn-danger delete"><i class="fas fa-trash mr-2"></i>Изтрий</button>
        </div>
    </li>

    <!-- Modal -->
    <div  class="modal fade" id="editCarOfferModal" tabindex="-1" role="dialog" aria-labelledby="editCarOfferModalTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCarOfferModalTitle">Редактирайте вашата Оферта</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Отказ">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="edit-car-form" name="edit-car">
                            <div class="row mt-2">
                                <div class="col-md-6 col-lg-4 w-100 p-lg-0 pb-4">
                                    <img src="assets/empty-image.jpg" id="carThumbnail"
                                        class="img-fluid img-responsive cardImage thumbnail w-100">
                                </div>
                                <div class="col-md-12 col-lg-8 d-flex flex-column">
                                    <div class="form-group">
                                        <label for="carImage">Линк към изображение</label>
                                        <input type="text" class="form-control" id="editCarImage" name="editCarImageName"
                                            placeholder="Дайте връзка към изображение на автомобила"
                                            formenctype="application/x-www-form-urlencoded">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-start row pt-2 mt-3">
                                <div class="col-md-12 col-lg-6 align-items-center flex-row">
                                    <div class="form-group">
                                        <label for="carBrand">Марка</label>
                                        <select class="form-control" id="editCarBrand" name="editCarBrandName">
                        
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-group" id="editModelFormGroup" hidden>
                                        <label for="carModel">Модел</label>
                                        <select class="form-control" id="editCarModel" name="editCarModelName">
                        
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-start row">
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-group">
                                        <label for="carEngine">Двигател</label>
                                        <div class="">
                                            <input type="text" class="form-control" name="editCarEngineName" id="editCarEngine" placeholder="Двигател">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-6 d-flex align-items-center flex-row">
                                    <div class="form-group">
                                        <label for="carPrice">Цена</label>
                                        <div class="">
                                            <input type="text" class="form-control" name="editCarPriceName" id="editCarPrice" placeholder="Цена">
                                        </div>
                                    </div>
                                    <div class="">
                                        <h6 class="m-2">лв.</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column">
                                <div class="form-group">
                                    <label for="shortDescription">Кратко описание</label>
                                    <textarea class="form-control" id="editCarShortDescription" rows="4" name="editCarShortDescriptionName"
                                        placeholder="Кратко описание за: година на производство, двигател, километраж, скоростна котия, цвят и др. "></textarea>
                                </div>
                                <input id="editId" name="editIdName" type="hidden" value="">
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="editDismiss" class="btn btn btn-secondary pull-right mybutton mr-3"><i
                            class="fas fa-times mr-2"></i>Отказ</button>
                    <button type="submit" id="editSaveCar" class="btn btn-success pull-right mybutton"><span
                            class="fas fa-save mr-2"></span>Публикувай</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        $(document).ready(function () {
            /*Взима логнат потребител, за да покаже страницата*/
            var loggedUser;
            var getLoggedUser = async function () {
                return $.ajax({
                    url: "/loggedUser",
                    method: "GET",
                    complete: function (data) {
                        switch (data.status) {
                            case 200:
                                loggedUser = data.responseJSON;
                                break;
                            case 401:
                                window.location.href = "index.html";
                                break;
                        }
                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadPageContent = async function () {
                loggedUser = await getLoggedUser();
                if (loggedUser != 'undefined') {
                    $('.wrapper').removeAttr('hidden');
                }
            }
            $('#logout').on('click', function () {
                $.ajax({
                    url: "logout",
                    method: "POST",
                    complete: function (data) {
                        if (data.status == 401) {
                            alert("ERROR!");
                        }
                        window.location.href = "index.html";
                    }
                })
            });
            loadPageContent();
            /*До тук за потребителя*/


            /*Връща всички оферти за коли*/
            var getAllCarsData = async function () {
                return $.ajax({
                    url: "/carOffers/byUser",
                    method: "GET",
                    success: function (response) {
                        return response;
                    }
                });
            }
            var buildCarsView = function (data) {
                $('#car-list').empty();
                data.forEach(element => {
                    bindCarsData(element);
                });
            }
            var bindCarsData = function (element) {
                let miniCar = $('#cloneCar').clone();

                miniCar.attr("id", element.id);
                miniCar.find('.carImage').attr("src", element.carImage);
                miniCar.find('.carBrand').text(element.carBrand.brand);
                miniCar.find('.carModel').text(element.carModel.model);
                miniCar.find('.carEngine').text(element.engine);
                miniCar.find('.carPrice').text(element.price);
                miniCar.find('.shortDescription').text(element.shortDescription);

                miniCar.find('.delete').click( async function () {
                    deleteCarOffer(element.id);
                });

                miniCar.find('.update').click(async function () {
                    openUpdateModal(element.id);
                });


                $('#car-list').prepend(miniCar);
                miniCar.show();
            }
            var loadCarsData = async function () {
                let data = await getAllCarsData();
                buildCarsView(data);
                loadBrandsData()
                $('#containerTop').removeAttr('hidden');
            }
            /*Връща всички оферти за коли*/
            loadCarsData();

            var deleteCarOffer = async function(carOfferId){
                return $.ajax({
                    url: "/carOffer/delete",
                    method: "DELETE",
                    data: { id: carOfferId },
                    complete: function (data) {
                        switch (data.status) {
                            case 200:
                                loadCarsData();
                                break;
                            case 401:
                                window.location.href = "index.html";
                                break;
                            case 404:
                                alert("You have to realise there is no comment!");
                                break;
                            case 418:
                                alert("Malicious intention detected!");

                                break;
                        }
                    }
                });
            }

            /*Display Brands*/
            var getBrands = async function () {
                return $.ajax({
                    url: "/carBrands/all",
                    method: "GET",
                    complete: function (data) {
                        return data.responseJSON;

                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadBrandsSelection = function (dropdown, element) {
                dropdown.append($('<option></option>').attr('value', element.id).text(element.brand));
            }
            var loadBrandsData = async function () {
                let carBrands = await getBrands();
                let dropdown = $('#car-brand-filter');
                dropdown.empty();
                dropdown.append('<option selected="true" disabled>Изберете марка автомобил</option>');
                dropdown.prop('selectedIndex', 0);
                carBrands.forEach(element => {
                    loadBrandsSelection(dropdown, element);
                });
            }
            /*Display Brands*/

            /*Display Models*/
            var getModels = async function () {
                return $.ajax({
                    url: "/carModels/brand",
                    method: "GET",
                    data: {
                        carBrand: $('#car-brand-filter :selected').val()
                    },
                    complete: function (data) {
                        return data.responseJSON;

                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            var loadModelsSelection = function (dropdown, element) {
                dropdown.append($('<option></option>').attr('value', element.id).text(element.model));
            }
            var loadModelsData = async function () {
                let carModels = await getModels();

                let selectModel = $('#car-model-filter');
                selectModel.empty();
                selectModel.append('<option selected="true" disabled>Изберете модел автомобил</option>');
                selectModel.prop('selectedIndex', 0);
                carModels.forEach(element => {
                    loadModelsSelection(selectModel, element);
                });
                $('#modelSelect').removeAttr('hidden');
            }
            /*Събития при натискане на бутон*/
            $('#getAll').on('click', function () {
                $('#search-description').val("")
                $('#car-brand-filter')[0].selectedIndex = 0;
                $('#car-model-filter')[0].selectedIndex = 0;
                $('#modelSelect').attr('hidden', true);
                loadCarsData();
            });
            $('#listView').on('click', function () {
                $('.cars-container').removeClass("container-fluid");
                $('.cars-container').addClass("container-lg");
                $('#car-list').removeClass("d-flex row flex-wrap");
                $('.list-group-item').removeClass("col-3");
                $('.item-container').addClass("row");
                $('.car-image-container').addClass("col-sm-4 col-lg-4");
                $('.car-info-container').addClass("col-sm-8 col-lg-8");
                $('.info').addClass("flex-row");
                $('.info').removeClass("flex-column");
                $('.price-cantainer').addClass("justify-content-end");
                $('.brandinfo').addClass("col-8");
                $('.priceinfo').addClass("col-4");
            });
            $('#gridView').on('click', function () {
                $('.cars-container').removeClass("container-lg");
                $('.cars-container').addClass("container-fluid");
                $('#car-list').addClass("d-flex row flex-wrap");
                $('.list-group-item').addClass("col-3");
                $('.item-container').removeClass("row");
                $('.car-image-container').removeClass("col-sm-4 col-lg-4");
                $('.car-info-container').removeClass("col-sm-8 col-lg-8");
                $('.info').removeClass("flex-row");
                $('.info').addClass("flex-column");
                $('.price-cantainer').removeClass("justify-content-end");
                $('.brandinfo').removeClass("col-8");
                $('.priceinfo').removeClass("col-4");
            });

            /*Събития при промяна на селекта*/
            $('#car-brand-filter').on('change', async function () {
                loadModelsData();
                $('#search-description').val("")
                let selectedFilter = $('#car-brand-filter :selected').val();
                let data = await getAllCarsData();
                let filteredData = data.filter(element => {
                    return element.carBrand.id == selectedFilter;
                });
                buildCarsView(filteredData);
            });

            $('#car-model-filter').on('change', async function () {
                $('#search-description').val("")
                let selectedFilterBrand = $('#car-brand-filter :selected').val();
                let selectedFilterModel = $('#car-model-filter :selected').val();
                let data = await getAllCarsData();
                let filteredData = data.filter(element => {
                    return (element.carBrand.id == selectedFilterBrand && element.carModel.id == selectedFilterModel);
                });
                buildCarsView(filteredData);
            });

            /*Търсачка по описание*/
            $('#search-description').on('keyup', async function () {

                $('#car-brand-filter')[0].selectedIndex = 0;
                $('#car-model-filter')[0].selectedIndex = 0;
                $('#modelSelect').attr('hidden', true);

                let value = $(this).val().toLowerCase();

                var getFilteredData = async function () {

                    let data = await getAllCarsData();

                    console.log(data);
                    let filteredData = data.filter(element => {
                        return element.shortDescription.toLowerCase().includes(value);
                    });

                    buildCarsView(filteredData);
                }
                setTimeout(getFilteredData, 500);
            });



        /*Модална форма за редактиране на офертата за кола*/
        function openUpdateModal(id) {

            $('#editCarOfferModal').modal('show');
            updateCarOffer(id);
                $('#editCarImage').trigger('focus');
                $('#editCarBrand').trigger('focus');
                $('#editCarModel').trigger('focus');
                $('#editCarEngineName').trigger('focus');
                $('#editCarPriceName').trigger('focus');
                $('#editCarShortDescription').trigger('focus');
            
            $('#editCarImage').change(function () {
                $('#carThumbnail').attr('src', $('#editCarImage').val());
            });
            var loadBrandsDataEdit = async function () {
                let carBrands = await getBrands();

                let dropdown = $('#editCarBrand');
                dropdown.empty();
                dropdown.append('<option selected="true" disabled>Изберете марка автомобил</option>');
                dropdown.prop('selectedIndex', 0);
                carBrands.forEach(element => {
                    loadBrandsSelection(dropdown, element);
                });
            }
            var loadModelsDataEdit = async function () {
                let carModels = await getModels();
                let selectModel = $('#editCarModel');
                selectModel.empty();
                selectModel.append('<option selected="true" disabled>Изберете модел автомобил</option>');
                selectModel.prop('selectedIndex', 0);
                carModels.forEach(element => {
                    loadModelsSelection(selectModel, element);
                });
                $('#editModelFormGroup').removeAttr('hidden');
            }

            var updateCarOffer = async function (carOfferId) {
                let carOfferToBe = await getOldOffer(carOfferId);
                $('#editCarOfferModal').modal('show');
                alert("I ma here");
                $('$editId').val(carOfferToBe.id); 
                console.log($('$editId').value);           
                $('#editCarImage').val(carOfferToBe.carImage);
                $('#carThumbnail').val(carOfferToBe.carImage)
                $('#editCarPrice').val(carOfferToBe.price);
                $('#editCarEngine').val(carOfferToBe.engine);

                await loadBrandsDataEdit();

                $("#editCarBrand option[value=carOfferToBe.carBrand.id]").attr('selected', 'selected');

                await loadModelsDataEdit();

                $("#editCarBrand option[value=carOfferToBe.carModel.id]").attr('selected', 'selected');
            }

            $('#editCarBrand').on('change', async function () {
                loadModelsDataEdit();
            });

            var getOldOffer = async function(carOfferId) {
                return $.ajax({
                    url: "/carOffer/get",
                    method: "GET",
                    data:{
                        id: carOfferId
                    },
                    complete: function (data) {
                        switch (data.status) {
                            case 200:
                                console.log();
                                return data.responseJSON;

                            case 401:
                                window.location.href = "index.html";
                                break;
                        }

                    }, fail: function () {
                        window.location.href = "index.html";
                    }
                });
            }
            $("form[name='edit-car']").validate({
                rules: {
                    editCarImageName: "required",
                    editCarBrandName: "required",
                    editCarModelName: "required",
                    editCarPriceName: {
                        required: true,
                        maxlength: 8,
                        digits: true
                    },
                    editCarEngineName: {
                        required: true,
                        maxlength: 30
                    },
                    editCarShortDescriptionName: {
                        required: true,
                        maxlength: 255
                    }
                },
                messages: {
                    editCarImageName: "Трябва да дадете URL адрес към изображение.",
                    editCarBrandName: "Изберете марка автомобил",
                    editCarModelName: "Изберете модел автомобил",
                    editCarPriceName: {
                        required: "Въведете цена",
                        maxlength: "Цената може да съдържа до 8 символа",
                        digits: "Цената може да съдържа само цифри"
                    },
                    editCarEngineName: {
                        required: "Въведете двигател",
                        maxlength: "Типа двигател може да съдържа до 30 символа"
                    },
                    editCarShortDescriptionName: {
                        required: "Въведете кратко описание",
                        maxlength: "Описанието може да съдържа до 255 символа"
                    }
                },
                submitHandler: function (form) {
                    event.preventDefault();

                    $.ajax({
                        url: '/carOffer/update',
                        method: "PUT",
                        data: {
                            id: $('$editId').val(),
                            image: $('#editCarImage').val(),
                            brand: $('#editCarBrand').val(),
                            model: $('#editCarModel').val(),
                            price: $('#editCarPrice').val(),
                            engine: $('#editCarEngine').val(),
                            shortDescription: $('#editCarShortDescription').val()
                        },
                        complete: function (data) {
                            switch (data.status) {
                                case 200:
                                    $('#editCarOfferModal').modal('hide');
                                    window.location.href = "myCarOffers.html";
                                    break;
                                case 400:
                                    alert("Въведените данни са невалидни!");
                                    break;
                                case 401:
                                    window.location.href = "index.html";
                                    break;
                            }

                        }, fail: function () {
                            alert("Въведените данни са невалидни!");
                        }
                    });
                }
            });
            
        }});


    </script>

</body>

</html>